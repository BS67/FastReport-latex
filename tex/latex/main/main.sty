\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{main}[2021/07/30 principal]






% =============================================================
% base packages
% =============================================================

\RequirePackage{xkeyval} %working with keys --> only one ProcessOptionsX, and every Options have to be with xkeyval
\RequirePackage{ifthen} 
\RequirePackage{etoolbox} % provides a lot of robusts commands, here for the toogle bool
\RequirePackage{fmtcount}	%for counters

% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
% Package Options
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$


\newtoggle{bib}
\newtoggle{svg}
\newtoggle{floatbarrier}
\newtoggle{link}
\newtoggle{quote}
\newtoggle{calc}
\newtoggle{showframe}


\DeclareOptionX{font}[libertine]{\newcommand{\myfont}{#1}}
\DeclareOptionX{calc}{			\ifthenelse{\equal{#1}{} \or \equal{#1}{true}}{\toggletrue{calc}}{}}
\DeclareOptionX{quote}{			\ifthenelse{\equal{#1}{} \or \equal{#1}{true}}{\toggletrue{quote}}{}}
\DeclareOptionX{floatbarrier}{\ifthenelse{\equal{#1}{} \or \equal{#1}{true}}{\toggletrue{floatbarrier}}{}}
\DeclareOptionX{link}{			\ifthenelse{\equal{#1}{} \or \equal{#1}{true}}{\toggletrue{link}}{}}
\DeclareOptionX{svg}{				\ifthenelse{\equal{#1}{} \or \equal{#1}{true}}{\toggletrue{svg}}{}}
\DeclareOptionX{bibstyle}{ \newcommand{\mybibstyle}{#1}}
\DeclareOptionX{bib}{				\ifthenelse{\equal{#1}{no}}{}{\toggletrue{bib} \newcommand{\bibfile}{#1}}}
\DeclareOptionX{table}{			\newcommand{\mylistoftables}{\listoftables}}
\DeclareOptionX{spacing}{\newcommand{\textspacing}{#1}}
\DeclareOptionX{language}{\newcommand{\doclanguage}{#1}}
\DeclareOptionX{geometry}[1]{\newcommand{\fancygeometry}{#1}}
\DeclareOptionX{showframe}{\toggletrue{showframe}}

\DeclareOptionX*{\PackageError{main_package}{the entry #1 doesn't exist}}

\ProcessOptionsX\relax
\providecommand{\myfont}{libertine}
\providecommand{\fancygeometry}{1}
\providecommand{\textspacing}{1.5}% if not defined, will be set to 1.5
\providecommand{\mybibstyle}{unsrt}
\providecommand{\doclanguage}{fr}
\providecommand{\mylistoftables}{}
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
% MAIN
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

\iftoggle{showframe}{\RequirePackage{showframe}}{}

% =============================================================
% raccourci de base
% =============================================================

\newcommand{\sbsec}{\subsection}
\newcommand{\sbbsec}{\subsubsection}
\newcommand{\para}{\paragraph*}
% =============================================================
% main Page style
% =============================================================


\PassOptionsToPackage{paper=a4paper}{geometry} 
\RequirePackage{geometry}
\ifthenelse{\equal{\fancygeometry}{1}}{
\newgeometry{tmargin=3cm,bmargin=3cm,lmargin=3cm,rmargin=1.5cm,headheight=100pt, headsep= 1cm, footskip=2cm}}{}
\ifthenelse{\equal{\fancygeometry}{2}}{
\newgeometry{tmargin=3cm,bmargin=3cm,lmargin=1.5cm,rmargin=1.5cm,headheight=100pt, headsep= 1cm, footskip=2cm}}{}


\savegeometry{normal}
\newgeometry{tmargin=0cm,bmargin=0cm,lmargin=1.5cm,rmargin=1.5cm,headheight=0cm, headsep=0cm}
\savegeometry{title}

% =============================================================
% text style
% =============================================================
\PassOptionsToPackage{document}{ragged2e} 
\RequirePackage{ragged2e} % permet un alignement du texte qui soit plus naturel avec les cmd: \Centering \RaggedLeft \RaggedRight
\RequirePackage{parskip}%pour avoir des parskip qui soient propre et qui ne donnent pas de trucs bizarre

%paragraph spacing
\setlength{\parindent}{5ex}
\widowpenalties 1 10000 %evite les pagebreaks au milieu des paragraphes

%text interspacing 
\RequirePackage{setspace}

		\ifthenelse{\equal{\textspacing}{1} }{\def\myspacing{\singlespacing} \setlength{\parskip}{1mm plus 3pt minus3pt } \def\setItemsep{0mm} \def\setParsep{0mm} 			
		%equation display 
		\setlength{\abovedisplayskip}{0.1cm}
		\setlength{\belowdisplayskip}{0.1cm}
		}{}
		\ifthenelse{\equal{\textspacing}{1.5} }{\def\myspacing{\onehalfspacing} \setlength{\parskip}{2mm plus 3pt minus3pt } \def\setItemsep{0.75mm} \def\setParsep{1mm}
		%equation display 
		\setlength{\abovedisplayskip}{0.5cm}
		\setlength{\belowdisplayskip}{0.5cm}
		}{}
		\ifthenelse{\equal{\textspacing}{2} }{\def\myspacing{\doublespacing} \setlength{\parskip}{5mm plus 3pt minus3pt } \def\setItemsep{1mm} \def\setParsep{1.5mm} 
		%equation display 
		\setlength{\abovedisplayskip}{0.7cm}
		\setlength{\belowdisplayskip}{0.7cm}
		}{}	
\myspacing
%main font

\ifthenelse{\equal{\myfont}{libertine}}{\RequirePackage{libertine} \RequirePackage{courier}}{
	\ifthenelse{\equal{\myfont}{CM}}{}{
		\ifthenelse{\equal{\myfont}{KPF}}{\RequirePackage{kpfonts}}{
			\ifthenelse{\equal{\myfont}{Utopia}}{\RequirePackage{fourier}}{
				\ifthenelse{\equal{\myfont}{DejaVu}}{\RequirePackage{dejavu}}{
					\ifthenelse{\equal{\myfont}{Bookman}}{\RequirePackage{tgbonum}}{
		
					}
				}
			}
		}
	}

}



%for every unit: \DeclareSIUnit{\fahrenheit}{\degree F} \SI{nb}{unit}
\RequirePackage{siunitx}
\DeclareSIUnit{\dBV}{dBV}
\sisetup{ detect-all = true }

%	==============================================================
%	figure, table, equation
% ==============================================================

\RequirePackage{graphics}
\PassOptionsToPackage{dvips}{graphicx}
\PassOptionsToPackage{svgnames}{xcolor}%donne des couleurs, ex: Midnightblue
\RequirePackage{graphicx,xcolor}
\RequirePackage{subcaption} %create cmd to make subcaption easyer



\RequirePackage{multirow} %: 
	%\multicolumn{nomb_col}{alignement ex:|c|}{contenu} 
	%\multirow{nomb_ligne}{largeur ex * }{contenu qui est 1 fusionné}

\setlength\textfloatsep{8pt plus 2pt minus 2pt}%espace avant float
\setlength\intextsep{8pt plus 2pt minus 2pt}%espace après float



%caption pour tableau, figure, subfigure
\RequirePackage{caption}
		\captionsetup[table]{justification=centering, format=hang,  labelfont={sc,tt}, textfont={bf,sl,tt}, skip=10pt, position=above, labelsep=colon}
		\captionsetup[figure]{justification=centering, format=hang, labelfont={sc,tt}, textfont={bf,sl,tt}, skip=10pt, position=bottom, labelsep=colon}	
		\captionsetup[sub]{justification=centering, format=hang, labelfont={sc,tt}, textfont={bf,sl,tt}, skip=10pt, labelsep=colon}

%compteur, met le num du chapitre aussi

\renewcommand{\thefigure}{\arabic{chapter}.\arabic{figure}}
\renewcommand{\thetable}{\arabic{chapter}.\arabic{table}}
\renewcommand{\thesubfigure}{\Alph{subfigure}}	

\ifthenelse{\equal{\doclanguage}{fr}}{\def\sourcename{Source}}{}
\ifthenelse{\equal{\doclanguage}{de}}{\def\sourcename{Quelle}}{}
\ifthenelse{\equal{\doclanguage}{en}}{\def\sourcename{Source}}{}


\newcommand{\source}[1]{\vspace{-3pt}\caption*{\sourcename:~ {#1}} }
%	==============================================================
%	structure dans float
% ==============================================================

% divise la page en 2 
%!!!! pas dans figure !!!
\newcommand\twopic[2]{
\hspace{-1cm}
\begin{minipage}[m]{0.5\textwidth}\centering#1 \end{minipage}%
\begin{minipage}[m]{0.5\textwidth}\centering#2 \end{minipage}
}

%regarder dans geometry pour trouver l'offset --> package automatique
\newcommand\sidecap[2]{
\begin{figure}[H]
	\hspace{-1cm}\begin{minipage}[m]{0.8\textwidth}\centering#1 \end{minipage}%
	\nolinebreak\hspace{0.5cm}\begin{minipage}[m]{0.3\textwidth} \small #2 \end{minipage}
\end{figure}
}

%\sidecap{img+caption...}{description}

% ===============================================================
% float & text repartition & floatbarrier
% ==============================================================
\iftoggle{floatbarrier}{ 
\PassOptionsToPackage{section, above}{placeins}
\RequirePackage{placeins}%\FloatBarrier
	\newcommand{\floatprotec}[2]{\FloatBarrier #1{#2} \FloatBarrier} %float barrier pour section automatique
		\renewcommand{\sbsec}{\floatprotec{\subsection}}
		\renewcommand{\sbbsec}{\floatprotec{\subsubsection}}
	\let\saveFloatBarrier\FloatBarrier	
	\newcommand{\desactivatefloatbarrier}{\let\FloatBarrier\relax}	
	\newcommand{\reactivatefloatbarrier}{\let\FloatBarrier\saveFloatBarrier}
}{}

\RequirePackage{float} %[H]

%partie text vs float
% [H] ici !
%[!h] ici si ca passe


\renewcommand\topfraction{0.9}% un float en haut de page a le droit de faire 90% de pageheight
\renewcommand\textfraction{0.35}%il faut au 35% de la hauteur de la page qui soit occupé de texte pur
\renewcommand\floatpagefraction{0.9}%ratio pour que une page occupé par un float devienne une page pur float

%	==============================================================
%	print table
% ==============================================================
\providecommand{\listofappendixs}{ }% si pas le package qui va avec
\providecommand{\biblio}{ }%si pas de bibliographie
\providecommand{\lstlistoflistings}{ }
\patchcmd{\listoffigures}{\chapter*}{\section}{}{}
\patchcmd{\listoftables}{\chapter*}{\section}{}{}


% ---------------------------------
% table print title language
% ---------------------------------
\ifthenelse{\equal{\doclanguage}{fr}}{\newcommand*{\tabletitle}{Listes \& Tables}}{}
\ifthenelse{\equal{\doclanguage}{de}}{\newcommand*{\tabletitle}{Verzeichnisse}}{}
\ifthenelse{\equal{\doclanguage}{en}}{\newcommand*{\tabletitle}{Tables}}{}



\newcommand\tables{
\def\sufchap{~}% supprimer une quelconque mise en forme provenant du style package
\def\prechap{}%dans style package
	\chapter{\tabletitle}
	\listoffigures
	\mylistoftables
\lstlistoflistings
	\listofappendixs
	\biblio
}

\setcounter{secnumdepth}{6}
\setcounter{tocdepth}{5}
%	==============================================================
%  svg
% ==============================================================


\iftoggle{svg}{
		\immediate\write18{svgtopng.exe}%transform every svg in svg/.png

}{}
	

	
%	==============================================================
%	enumerations
% ==============================================================		
\PassOptionsToPackage{inline}{enumitem}
\RequirePackage{enumitem}%parametrer enumeration
%liste
%les listes * on le même paramétrage que les listes normales
\setlist[enumerate]{itemsep=0.75mm , topsep = 0mm, parsep=1mm, labelindent=5pt, label= \arabic*.,font=\bfseries}
\setlist[description]{itemsep=0.75mm, topsep = 0mm, parsep=1mm, labelindent=5pt }
\setlist[itemize]{itemsep=0.75mm, topsep = 0mm, parsep=1mm, labelindent=5pt, label=\textbullet }	

%2 nouveaux formats pour des subliste
\newcommand{\doublepoint}[1]{{\bfseries #1 ~:~}}

\SetEnumitemKey{dp}{font=\doublepoint, labelindent=1cm,leftmargin = 1.5cm, itemindent=-0.5cm}
\SetEnumitemKey{sblist}{labelindent=1cm, leftmargin = *,label= \alph*)}
\SetEnumitemKey{sbblist}{labelindent=1.5cm, leftmargin = *,label= \textit{(\roman*)}}
\makeatletter
	\@beginparpenalty=1000 % high penality -> do not encourage break
	\@itempenalty=10000% high penality -> do not encourage break
	\@endparpenalty=1% low penality ->  encourage break
\makeatother
%	==============================================================
%	langue & typesettings
% ==============================================================
	\PassOptionsToPackage{T1}{fontenc}
\RequirePackage{fontenc}
	\PassOptionsToPackage{utf8}{inputenc}
\RequirePackage{inputenc}
	

			\ifthenelse{\equal{\doclanguage}{fr}}
			{%option is french
					\PassOptionsToPackage{french}{babel}
					\PassOptionsToPackage{french}{isodate}
			}{
			\ifthenelse{\equal{\doclanguage}{de}}
			{%option is german
					\PassOptionsToPackage{ngerman}{babel}
					\PassOptionsToPackage{german}{isodate}
			}{
			\ifthenelse{\equal{\doclanguage}{en}}
			{%option is english
					\PassOptionsToPackage{english}{babel}
					\PassOptionsToPackage{english}{isodate}
			}
			{
			\PackageError{main-package}{you didn't choosed a language}{package options: fr, de, en}
			}}}		

	
	\RequirePackage{babel}
	\RequirePackage{isodate} % dateprint: https://mirrors.chevalier.io/CTAN/macros/latex/contrib/isodate/isodate.pdf

%	==============================================================
%	maths
% ==============================================================

%compteur, rajoute le num du chapitre 
\renewcommand{\theequation}{\arabic{chapter}.\arabic{equation}}




%compteur pour exercice
		\ifthenelse{\equal{\doclanguage}{fr}}{\def\exercice{Exercice}}{}
		\ifthenelse{\equal{\doclanguage}{de}}{\def\exercice{Aufgabe}}{}
		\ifthenelse{\equal{\doclanguage}{en}}{\def\exercice{Exercice}}{}


			\newcounter{exo}
				\setcounter{exo}{0}
				\newcommand{\exosuivant}
				{
					\addtocounter{exo}{1}
					\vp\noindent{\bf \exercice {\theexo}.\\ }
				}




\newcommand{\bc}{\begin{cases}} 
\newcommand{\ec}{\end{cases}}
				
				
			\PassOptionsToPackage{fleqn}{amsmath}
			\PassOptionsToPackage{allowspaces}{mathtools} %https://ctan.crest.fr/tex-archive/macros/latex/contrib/mathtools/mathtools.pdf
			\RequirePackage{amsmath,amssymb,amsfonts, mathtools}%mathtools très très puissant voir si problème il y a enormément de chose
			
		\providecommand\eq[1]{\begin{align}#1\end{align}} %equations
		\providecommand\noeq[1]{\begin{align*}#1\end{align*}}
				
		\mathtoolsset{showonlyrefs}
		\usetagform{default}

		\providecommand{\bc}{\begin{dcases}} 
		\providecommand{\ec}{\end{dcases}}

		\newcommand*\abs[1]{\lvert#1\rvert}

		\newcommand{\N}{\mathbb{N}}
		\newcommand{\R}{\mathbb{R}}
		\newcommand{\C}{\mathbb{C}}
		\newcommand{\Z}{\mathbb{Z}}
		\newcommand{\Q}{\mathbb{Q}}
		\newcommand{\K}{\mathbb{K}}
		\newcommand{\U}{\mathbb{U}}
		\newcommand{\Mn}{\mathcal{M}_n}
		\newcommand{\M}{\mathcal{M}}
		\newcommand{\B}{\mathcal{B}}
		\newcommand{\A}{\mathcal{A}}
		\newcommand{\F}{\mathcal{F}}
		\renewcommand{\L}{\mathcal{L}}
	
			
			%equations
			
			

			
	
\iftoggle{calc}{
					\RequirePackage{calculator}% faire des calculs avec latex
				}{}
			
%	==============================================================
%	footnote
% ==============================================================
%protecting: etoolbox robust cmd
					
\newcommand{\fnm}{\footnotemark~}
\newcommand{\pnm}{\protecting{\footnotemark}~} % a utiliser dans ce qui est écrit dans les tables 
\newcommand{\fnt}{\footnotetext}
					
				
%	==============================================================
%	quote
% ==============================================================	
\iftoggle{quote}{
					\PassOptionsToPackage{babel=true, csdisplay=true}{csquotes} %enquote{}
					\RequirePackage{csquotes} 
					%bcp bcp d'option aller regarder: https://mirror.ibcp.fr/pub/CTAN/macros/latex/contrib/csquotes/csquotes.pdf
				\RequirePackage{epigraph} % sectional heading: https://mirrors.chevalier.io/CTAN/macros/latex/contrib/epigraph/epigraph.pdf
				
				
				\ifthenelse{\equal{\doclanguage}{fr}}{\setquotestyle[quotes]{french}}{}
				\ifthenelse{\equal{\doclanguage}{de}}{\setquotestyle[quotes]{german}}{}
				\ifthenelse{\equal{\doclanguage}{en}}{\setquotestyle[quotes]{english}}{}
				
				
}{}
		



%	==============================================================
%	bibtex
% ==============================================================

\iftoggle{bib}{
					\RequirePackage{cite}	
					\patchcmd{\thebibliography}{\chapter*{\bibname}}{\section{\bibname}}{}{} %transforme le chapitre en section

					\def\biblio{ 
							\bibliographystyle{\mybibstyle}
							\bibliography{\bibfile}
					}
					
}{}

%	==============================================================
%	spaces
% ==============================================================	
\newcommand{\emptypage}{
												\newpage
												\strut
												\newpage
											 }

% espaces verticaux et horizontaux
	\newcommand{\vp}{\vspace{0.2cm}\newline}
	\newcommand{\vpp}{\vspace{0.1cm}\newline}
	\newcommand{\vg}{\vspace{0.4cm}\newline}

	\newcommand{\br}{\newline \indent}



%	==============================================================
%	link -> hyperref toujours a la fin
% ==============================================================
	
\iftoggle{link}{
		\PassOptionsToPackage{hyphens}{url}							%sinon prob de cohésion entre hyperrref et {hyphen}url pour que les longues url breaks 
		\PassOptionsToPackage{urlcolor=cyan,pdftex}{hyperref}
		\RequirePackage{url}
		\RequirePackage{hyperref}	
			\def\UrlBreaks{\do\.\do\@\do\\\do\/\do\!\do\_\do\|\do\;\do\>%
			\do\]\do\)\do\,\do\?\do\'\do+\do\=\do\#\do\a\do\b\do\c\do\d\do\e\do\f\do\g\do\h\do\i\do\j\do\k\do\l\do\m\do\n\do\o\do\p\do\q\do\r\do\s\do\t\do\u\do\v\do\w\do\x\do\y\do\z%
			\do\A\do\B\do\C\do\D\do\E\do\F\do\G\do\H\do\I\do\J\do\K\do\L\do\M\do\N\do\O\do\P\do\Q\do\R\do\S\do\T\do\U\do\V\do\W\do\X\do\Y\do\Z%
			\do\1\do\2\do\3\do\4\do\5\do\6\do\7\do\8\do\9\do\%\do\=}%

	\newcommand{\refA}[2]{\hyperlink{#1B}{\hypertarget{#1A}{#2}}}
	\newcommand{\refB}[2]{\hypertarget{#1B}{\hyperlink{#1A}{#2}}}
	\let\oldurl\url
	\renewcommand{\url}[2]{\href{#1}{#2}}
}{}

\let\oldref\ref
\renewcommand{\ref}{ \oldref} %ajoute un espace avant		