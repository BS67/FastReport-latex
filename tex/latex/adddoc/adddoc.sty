\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{adddoc}[2021/07/30 annexes]







% =============================================================
% base packages
% =============================================================

\RequirePackage{xkeyval} %working with keys --> only one ProcessOptionsX, and every Options have to be with xkeyval
\RequirePackage{ifthen} 
\RequirePackage{etoolbox} % provides a lot of robusts commands, here for the toogle bool
\RequirePackage{fmtcount}	%for counters
\RequirePackage{totcount}
\providecommand\mytotfile{totcnt.aux}
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
% Package Options
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

\newtoggle{attach} 
\newtoggle{code}
\newtoggle{algo}

\DeclareOptionX{actif}[true]{\toggletrue{attach} \def\activ{#1}} %print the table
\DeclareOptionX{pathappendix}{\newcommand{\appath}{#1}} %Anhang/
\DeclareOptionX{code}{\toggletrue{code}}
\DeclareOptionX{logo}{\newcommand{\appathlogo}{#1}}%logo a mettre en entête
\DeclareOptionX{language}{\newcommand{\doclanguage}{#1}}
\DeclareOptionX{fancyfooter}{\newcommand{\fancyfooter}{#1}}%titre milieux de page
\DeclareOptionX{algo}{\toggletrue{algo}}%titre milieux de page
\ProcessOptionsX\relax

%if not defined
\providecommand{\appathlogo}{no}
\providecommand{\appath}{ }
\providecommand{\doclanguage}{fr}
\providecommand{\fancyfooter}{}
%	================================================================================================================================
%	attachement
% ==================================================================================================================================

\iftoggle{attach}{

	\RequirePackage{titletoc}

%	-------------------------------------------------------------
%	langues
% -------------------------------------------------------------
%langue
\ifthenelse{\equal{\doclanguage}{fr}}
			{%option is french
					\newcommand{\listappendixname}{Table des Annexes}
					\newcommand{\attachname}{Annexes}
			}{
\ifthenelse{\equal{\doclanguage}{de}}
			{%option is german
					\newcommand{\listappendixname}{Anhangsverzeichnis}
					\newcommand{\attachname}{Anhänge}
			}{
\ifthenelse{\equal{\doclanguage}{en}}
			{%option is english
					\newcommand{\listappendixname}{Table of Appendices}
					\newcommand{\attachname}{Appendices}
			}{}}}
			
			
%	-------------------------------------------------------------
%	theorie
% -------------------------------------------------------------

%\addcontentsline{ext}{section}{title} 
%		---> écrit dans root.ext file \contentsline{section}{title}{page from the addcontent cmd }   
%				---> in the \listofappendix will be read: \l@appendix{title}{page} 
%						-->\@dottedtocline{lvl}{left indent}{numwidth }{title}{page}

%*numwidth: espace alloqué pour le section num dans \numberline

%title can be set with: \numberline{section num}{section title} in the addcontentsline



%	-------------------------------------------------------------
%	compteurs
% --------------------------------------------------------------
\newcounter{achapter}%chapter for appendix
\newcounter{appendix}[achapter]%real attachment


%format des compteurs
\makeatletter
	\renewcommand*{\theachapter}{\@Alph\c@achapter}
	\renewcommand*{\theappendix}{\ifnum \c@achapter>\z@ \theachapter.\fi \@arabic\c@appendix}
\makeatother

%	-------------------------------------------------------------
%	rendu de la table des matière
% --------------------------------------------------------------
%rendu dans la table


\makeatletter
	\newcommand*\l@achapter[2]{%	
												\addvspace{2.25em \@plus\p@}% espace de séparation entre titre
													{
														\leavevmode
														\hspace{0em}  #1 \hfill % indent, 
													}\par\nobreak
												} 
																
	\newcommand*\l@appendix{\@dottedtocline{1}{2.5em}{2.3em}} 
\makeatother

\contentsuse{appendix}{loap}


\let\listofappendixs\listoftables
%on adapte juste la table des matières, le code est pas compliqué mais c'est plus simple comme ca
\patchcmd{\listofappendixs}{\listtablename}{\listappendixname}{}{}
\patchcmd{\listofappendixs}{\listtablename}{\listappendixname}{}{}
\patchcmd{\listofappendixs}{\listtablename}{\listappendixname}{}{}
\patchcmd{\listofappendixs}{lot}{loap}{}{}

%	-------------------------------------------------------------
%	commande d'entrée
% --------------------------------------------------------------
\usepackage{pdflscape}





\newcommand\attachment[2]{
									\refstepcounter{appendix}
									\label{ap:#1}
									\addcontentsline{loap}{appendix}{\numberline{\theappendix}{\itshape #2}}
									}
\newcommand\achapter[1]{
								\refstepcounter{achapter}
								\def\achaptertitle{#1}
								\addcontentsline{loap}{achapter}{\bfseries\theachapter \hspace{1em} #1}%style, espacement entre num et label 
								}
\newcommand\asection[2]{
						\attachment{#1}{#2}
						\section*{\theappendix\hspace{1cm} #2}
}

\newcommand\lspapp[3]{%landscapeappendix
	\begin{landscape}
		\asection{#1}{#2}
		#3
	\end{landscape}
}

%	-------------------------------------------------------------
%	style de page
% --------------------------------------------------------------
\RequirePackage{geometry}
\def\achaptertitle{}%initialiser pour le style de page

\ifthenelse{\equal{\appathlogo}{no}}{%no logo avaible for page head
															\newcommand{\apheadlogo}{}
															}{%logo avaible for page head
															\newcommand{\apheadlogo}{\hfill\mbox{\includegraphics[width=0.3\textwidth]{\appathlogo}}}
															}	


\newpagestyle{appendix}{%
	\pagenumbering{Roman}
	\sethead{\fontsize{20pt}{0pt}\selectfont \scshape \Alph{achapter}.\hspace{3mm} \achaptertitle}{}{\hfill\mbox{\apheadlogo}}
	\setfoot{\fancyfooter}{\centering \thepage}{}
	\headrule
	\setheadrule{0.4pt}
}




%	-------------------------------------------------------------
%	initialisation de l'appendix
% --------------------------------------------------------------


\let\oldappendix\appendix
\renewcommand{\appendix}{%
													%\setcounter{LastPage}{\value{page}}???
													\clearpage
													\pagestyle{empty}
													\oldappendix
													\addcontentsline{toc}{chapter}{\attachname}
													\part*{\attachname}
													\pagestyle{appendix}
													\newgeometry{tmargin=2cm,bmargin=1.5cm,lmargin=0.5cm,rmargin=0.5cm,headheight=100pt, headsep=0.5cm, footskip=1cm}
												}

%	-------------------------------------------------------------
%	annexes en pdf
% -------------------------------------------------------------


\RequirePackage{pdfpages}													
%\pdf[langscape->true/false]{titre}{ref}{nom du doc avec extension}												
\newcommand{\pdf}[4][false]%
{
	\attachment{#2}{#3}
	\includepdf[scale=.8, pages=-,offset ={0cm -2cm}, landscape=#1, pagecommand={\section*{#2}}]{\appath#4}
									}

	%\pdf[langscape->true/false]{taille}{titre}{ref}{nom du doc avec extension}		
\newcommand{\pdfsize}[5][false]%
	{ 	
		\attachment{#3}{#4}
		\includepdf[scale=#2, pages=-,offset ={0cm -2cm}, landscape=#1, pagecommand={\section*{#3}}]{\appath#5}
	}


\makeatletter

	\define@key{pdfoptions}{scale}[0.8]{\def\pdf@scale{#1} }
	\define@key{pdfoptions}{offseth}[-2cm]{\def\pdf@offseth{#1}}
	\define@key{pdfoptions}{offsetw}[0cm]{\def\pdf@offsetw{#1}}
	\define@key{pdfoptions}{landscape}[false]{\def\pdf@landscape{#1} }
	\define@key{pdfoptions}{title}[]{\def\pdf@title{#1} }
	\define@key{pdfoptions}{ref}[]{\def\pdf@ref{#1} }



\newcommand{\pdfoptions}[2][]
{
	\setkeys{pdfoptions}{#1}
	\attachment{\pdf@title}{ap:\pdf@ref}
	\includepdf[scale=\pdf@scale, pages=-,offset ={\pdf@offsetw, \pdf@offseth}, landscape=\pdf@landscape, pagecommand={\section*{\pdf@title}}]{\appath#2}
}
\makeatother
	%---------------------------------------
	%impression de la table 
	%---------------------------------------
	
	\ifthenelse{\equal{\activ}{false}}%
	{\def\listofappendixs{}}%annule la commande quand on ne veut pas
	{}%laisse la commande intacte
	
	
	
}{}	




%$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
%code
%$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$


%----------------------------------------------------------------
%langues
%----------------------------------------------------------------
\ifthenelse{\equal{\doclanguage}{fr}}
			{%option is french
					\PassOptionsToPackage{french,ruled,vlined}{algorithm2e} 
			}{
\ifthenelse{\equal{\doclanguage}{de}}
			{%option is german
					\PassOptionsToPackage{german,ruled,vlined}{algorithm2e} 
			}{
\ifthenelse{\equal{\doclanguage}{en}}
			{%option is english
					\PassOptionsToPackage{english,ruled,vlined}{algorithm2e} 
			}{}}}

%make title of listofalgorithms => section*


\let\listofalgorithms\undefined
\RequirePackage{algorithm2e}
\makeatletter
	\def\algocf@seclistalgo{\section}
\makeatother

\iftoggle{algo}{
	\patchcmd{\listofalgocfs}{*}{ }{}{}%section* => section
}{
	\def\listofalgorithms{}
}


\iftoggle{code}{
	%----------------------------------------------------------------
	%langues
	%----------------------------------------------------------------
	\ifthenelse{\equal{\doclanguage}{fr}}
	{%option is french
			\renewcommand{\lstlistingname}{Extrait de code }
			\renewcommand{\lstlistlistingname}{Extraits de code}
	}{
	\ifthenelse{\equal{\doclanguage}{de}}
	{%option is german
			\renewcommand{\lstlistingname}{Code-Abschnitt}
			\renewcommand{\lstlistlistingname}{Code-Verzeichnis}
	}{
	\ifthenelse{\equal{\doclanguage}{en}}
	{%option is english
			\renewcommand{\lstlistingname}{Code-Extract}
			\renewcommand{\lstlistlistingname}{Table of code}
	}{}}}

	\RequirePackage{listings}

	\makeatletter
		\patchcmd{\lstlistoflistings}{\float@listhead}{\section}{}{}
	\makeatother
%----------------------------------------------------------------
%general cmd
%----------------------------------------------------------------
\newcommand{\lstcolor}[2]{\texttt{\textcolor{#1}{#2}}}

\newcommand\cref[1]{\texttt{\lstlistingname} \ref{c:#1}.~}

%environement -> begin{code}{option}
\newenvironment{code}[1]%
		{\begin{minipage}{\textwidth} \begin{lstlisting}[#1]}
		{\end{lstlisting}\end{minipage}}

  
%----------------------------------------------------------------
%caption
%----------------------------------------------------------------
\RequirePackage{caption}
\captionsetup[lstlisting]{position=above, font={tt}, labelfont={sc}, textfont={bf}}



%----------------------------------------------------------------
%remedier aux bugs des caractères utf8 dans les environnemnets listings
%----------------------------------------------------------------

    \lstset{
        numberbychapter=false,
        captionpos = top,
        inputencoding = utf8,  % Input encoding
        extendedchars = true,  % Extended ASCII
        literate      =        % Support additional characters
          {á}{{\'a}}1  {é}{{\'e}}1  {í}{{\'i}}1 {ó}{{\'o}}1  {ú}{{\'u}}1
          {Á}{{\'A}}1  {É}{{\'E}}1  {Í}{{\'I}}1 {Ó}{{\'O}}1  {Ú}{{\'U}}1
          {à}{{\`a}}1  {è}{{\`e}}1  {ì}{{\`i}}1 {ò}{{\`o}}1  {ù}{{\`u}}1
          {À}{{\`A}}1  {È}{{\`E}}1  {Ì}{{\`I}}1 {Ò}{{\`O}}1  {Ù}{{\`U}}1
          {ä}{{\"a}}1  {ë}{{\"e}}1  {ï}{{\"i}}1 {ö}{{\"o}}1  {ü}{{\"u}}1
          {Ä}{{\"A}}1  {Ë}{{\"E}}1  {Ï}{{\"I}}1 {Ö}{{\"O}}1  {Ü}{{\"U}}1
          {â}{{\^a}}1  {ê}{{\^e}}1  {î}{{\^i}}1 {ô}{{\^o}}1  {û}{{\^u}}1
          {Â}{{\^A}}1  {Ê}{{\^E}}1  {Î}{{\^I}}1 {Ô}{{\^O}}1  {Û}{{\^U}}1
          {œ}{{\oe}}1  {Œ}{{\OE}}1  {æ}{{\ae}}1 {Æ}{{\AE}}1  {ß}{{\ss}}1
          {ẞ}{{\SS}}1  {ç}{{\c{c}}}1 {Ç}{{\c{C}}}1 {ø}{{\o}}1  {Ø}{{\O}}1
          {å}{{\aa}}1  {Å}{{\AA}}1  {ã}{{\~a}}1  {õ}{{\~o}}1 {Ã}{{\~A}}1
          {Õ}{{\~O}}1  {ñ}{{\~n}}1  {Ñ}{{\~N}}1  {¿}{{?`}}1  {¡}{{!`}}1
          {°}{{\textdegree}}1 {º}{{\textordmasculine}}1 {ª}{{\textordfeminine}}1
          {£}{{\pounds}}1  {©}{{\copyright}}1  {®}{{\textregistered}}1
          {«}{{\guillemotleft}}1  {»}{{\guillemotright}}1  {Ð}{{\DH}}1  {ð}{{\dh}}1
          {Ý}{{\'Y}}1    {ý}{{\'y}}1    {Þ}{{\TH}}1    {þ}{{\th}}1    {Ă}{{\u{A}}}1
          {ă}{{\u{a}}}1  {Ą}{{\k{A}}}1  {ą}{{\k{a}}}1  {Ć}{{\'C}}1    {ć}{{\'c}}1
          {Č}{{\v{C}}}1  {č}{{\v{c}}}1  {Ď}{{\v{D}}}1  {ď}{{\v{d}}}1  {Đ}{{\DJ}}1
          {đ}{{\dj}}1    {Ė}{{\.{E}}}1  {ė}{{\.{e}}}1  {Ę}{{\k{E}}}1  {ę}{{\k{e}}}1
          {Ě}{{\v{E}}}1  {ě}{{\v{e}}}1  {Ğ}{{\u{G}}}1  {ğ}{{\u{g}}}1  {Ĩ}{{\~I}}1
          {ĩ}{{\~\i}}1   {Į}{{\k{I}}}1  {į}{{\k{i}}}1  {İ}{{\.{I}}}1  {ı}{{\i}}1
          {Ĺ}{{\'L}}1    {ĺ}{{\'l}}1    {Ľ}{{\v{L}}}1  {ľ}{{\v{l}}}1  {Ł}{{\L{}}}1
          {ł}{{\l{}}}1   {Ń}{{\'N}}1    {ń}{{\'n}}1    {Ň}{{\v{N}}}1  {ň}{{\v{n}}}1
          {Ő}{{\H{O}}}1  {ő}{{\H{o}}}1  {Ŕ}{{\'{R}}}1  {ŕ}{{\'{r}}}1  {Ř}{{\v{R}}}1
          {ř}{{\v{r}}}1  {Ś}{{\'S}}1    {ś}{{\'s}}1    {Ş}{{\c{S}}}1  {ş}{{\c{s}}}1
          {Š}{{\v{S}}}1  {š}{{\v{s}}}1  {Ť}{{\v{T}}}1  {ť}{{\v{t}}}1  {Ũ}{{\~U}}1
          {ũ}{{\~u}}1    {Ū}{{\={U}}}1  {ū}{{\={u}}}1  {Ů}{{\r{U}}}1  {ů}{{\r{u}}}1
          {Ű}{{\H{U}}}1  {ű}{{\H{u}}}1  {Ų}{{\k{U}}}1  {ų}{{\k{u}}}1  {Ź}{{\'Z}}1
          {ź}{{\'z}}1    {Ż}{{\.Z}}1    {ż}{{\.z}}1    {Ž}{{\v{Z}}}1
          % ¿ and ¡ are not correctly displayed if inconsolata font is used
          % together with the lstlisting environment. Consider typing code in
          % external files and using \lstinputlisting to display them instead.      
      }

%----------------------------------------------------------------
%c++ style
%----------------------------------------------------------------
    
	
        \definecolor{cpp-background}{RGB}{0,0,0}
		\definecolor{cpp-text}{RGB}{255,255,255}
		\definecolor{cpp-string}{RGB}{163,21,21}
		\definecolor{cpp-namespace}{RGB}{255,255,255}
		\definecolor{cpp-preprocessor}{RGB}{128,128,128}
		\definecolor{cpp-keyword}{RGB}{0,0,255}
		\definecolor{cpp-type}{RGB}{43,145,175}
		\definecolor{cpp-variable}{RGB}{255,255,255}
		\definecolor{cpp-constant}{RGB}{111,156,234} % macro color
		\definecolor{cpp-comment}{RGB}{218,240,13}
		\definecolor{cpp-serial}{RGB}{22,219,194}
		\definecolor{cpp-add}{RGB}{101,156,234}
	
	
		\lstdefinestyle{c++}%
		{
			backgroundcolor=\color{cpp-background},
			basicstyle=\scriptsize\ttfamily\color{cpp-text}, % any text
			stringstyle=\color{cpp-string},
			identifierstyle=\color{cpp-text}, % just about anything that isn't a directive, comment, string or known type
			commentstyle=\color{cpp-comment},
			keywordstyle=\color{cpp-type},
			morekeywords={[2]char,int,void, long,enum}, keywordstyle={[2]				\color{cpp-constant}}, % you'll need to define these or use a custom language
			morecomment=[s][\color{red}]{/*!}{*/},
			tabsize=4,
			escapeinside={<@}{@>},
			captionpos=b,
			frame=single,
			framexleftmargin=5pt,
			framexrightmargin=0.5cm,
			numberbychapter=false,
			morekeywords ={Serial,Serial1,Serial2},keywordstyle=\color{cpp-serial}
		}
            


     
        	\lstdefinestyle{matlab}{
            language=Matlab,
            breaklines=true,
            basicstyle=\small\ttfamily,
            keywordstyle=\color{blue},
            commentstyle=\color{green!40!black},
            stringstyle=\color{red},
            numbers=left,
            numberstyle=\tiny\color{gray},
            stepnumber=1,
            numbersep=5pt,
            backgroundcolor=\color{gray!5},
            frame=single,
            rulecolor=\color{black!30},
            captionpos=b,
            tabsize=2,
            showspaces=false,
            showstringspaces=false
            }









}{}