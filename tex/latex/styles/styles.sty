\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{styles}[2021/01/16 mes styles]


% =============================================================
% base packages
% =============================================================

\RequirePackage{xkeyval} %working with keys --> only one ProcessOptionsX, and every Options have to be with xkeyval
\RequirePackage{ifthen} 
\RequirePackage{etoolbox} % provides a lot of robusts commands, here for the toogle bool
%\RequirePackage{fmtcount}	%for  counters style

% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
% Package Options
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

\newtoggle{newchappage}
\toggletrue{newchappage}
\DeclareOptionX{NewChapPage}{\ifthenelse{\equal{#1}{} \or \equal{#1}{true}}{}{\togglefalse{newchappage}}}	%for chapter create new page or not 	
\DeclareOptionX{ChapPrefix}{\newcommand{\prefixchap}{#1}} % met un préfix devant le nom des chapitres, ex: Projet I
\DeclareOptionX{titlenum}{\newcommand{\titlenum}{#1}}%numérotation
\DeclareOptionX{fancytitle}{\newcommand{\fancytitle}{#1}}%savoir quel style de titre
\DeclareOptionX{fancypage}{\newcommand{\fancypage}{#1}}%savoir quel style de titre
\DeclareOptionX{logo}{\newcommand{\pathlogo}{#1}}%logo a mettre en entête
\DeclareOptionX{name}{\newcommand{\name}{{\begin{tabular}[b]{l@{}} #1 \end{tabular} }}}%noms à mettre en en-tête nom \\ nom ....
\DeclareOptionX{titre}{\newcommand{\titre}{#1}}%titre milieux de page
\DeclareOptionX{fancyfooter}{\newcommand{\fancyfooter}{#1}}%titre milieux de page
%securité
\DeclareOptionX{Chapprefix}{\PackageError{styles_package}{ChapPrefix avec les majuscules}}
\DeclareOptionX{chapprefix}{\PackageError{styles_package}{ChapPrefix avec les majuscules}}
\DeclareOptionX{NewChappage}{\PackageError{styles_package}{NewChapPage avec les majuscules}}
\DeclareOptionX{Newchappage}{\PackageError{styles_package}{NewChapPage avec les majuscules}}
\DeclareOptionX{newchappage}{\PackageError{styles_package}{NewChapPage avec les majuscules}}
\DeclareOptionX{newChapPage}{\PackageError{styles_package}{NewChapPage avec les majuscules}}
\ProcessOptionsX\relax

\providecommand{\fancyfooter}{}
\providecommand{\prefixchap}{}
\providecommand{\name}{}
\providecommand{\titre}{}
\providecommand{\titlenum}{0}% if not defined, will be set to 1
\providecommand{\fancytitle}{0}% if not defined, will be set to 1
\providecommand{\fancypage}{0}% if not defined, will be set to 1
\providecommand{\pathlogo}{no}% if not defined, will be set to 1

% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
% MAIN
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
\PassOptionsToPackage{indentafter, pagestyles}{titlesec}%titre, entête et pied de page
\RequirePackage{titlesec}

% ==============================================================
%	boites
% ==============================================================

\usepackage{tcolorbox}

\newtcolorbox[]{defbox}[1][]{%
colback=red!50!white,colframe=red!75!black,fonttitle=\bfseries,
title={Définition : ~#1}}

\newtcolorbox{exbox}{%
colback=green!50!white,colframe=green!75!black,fonttitle=\bfseries,
title={Exemple}}

\newtcolorbox{rembox}{%
colback=blue!50!white,colframe=blue!75!black,fonttitle=\bfseries,
title={Remarque}}

\newcommand{\tbox}[2]{\begin{tcolorbox}#1\end{tcolorbox}}

%	==============================================================
%	additional commands
% ==============================================================
\newcommand{\varnewpage}[1]{%
  \ifdim\dimexpr\textheight-\pagetotal\relax>#1\baselineskip
  %\the\numexpr\dimexpr\textheight-\pagetotal\relax/\baselineskip\relax
  % There's enough space, no action needed
  \else
  %\the\numexpr\dimexpr\textheight-\pagetotal\relax/\baselineskip\relax
	\vspace*{\fill}  
  \newpage%  if not enough space
  \fi
}

\let\oldsection\section
\renewcommand{\section}{\varnewpage{18}\oldsection}

\let\oldsubsection\subsection
\renewcommand{\subsection}{\varnewpage{13}\oldsubsection}

\let\oldsubsubsection\subsubsection
\renewcommand{\subsubsection}{\varnewpage{13}\oldsubsubsection}

\newcommand{\resetsecautoskip}{
	\let\section\oldsection
	\let\subsection\oldsubsection
	\let\subsubsection\oldsubsubsection
}


%	==============================================================
%	prefix/suffix management
% ==============================================================

\newcommand{\thechaptertitle}{}

\newcommand{\nocprefix} % pas de préfixe
	{
		\def\sufchap{~} 
		\def\chappoint{.} % I.
		\def\prechap{} % supprime le préfixe
	}
	
\newcommand{\cprefix} % préfixe activé
	{
		\def\sufchap{:~} %ajout d'un ":"
		\def\chappoint{} % I
		\def\prechap{\prefixchap~} % ajoute le préfixe
	}


\ifthenelse{\equal{\prefixchap}{}}{\nocprefix}{\cprefix} 




%	==============================================================
%	title numerotation
% ==============================================================

%ajout d'une numérotation juste pour les titres de chapitres !!!
\ifthenelse{\equal{\titlenum}{1}}
		{
			\makeatletter
			\renewcommand{\thechaptertitle}{\@Roman\c@chapter\chappoint}
			\renewcommand{\thechapter}{\@Roman\c@chapter.} 
			\renewcommand{\thesection}{\@arabic\c@section.}
			\renewcommand\thesubsection {\thesection\@arabic\c@subsection}
			\renewcommand{\thesubsubsection}{\thesubsection\@Alph\c@subsubsection}
			\renewcommand{\theparagraph}{\@alph\c@paragraph)}
			\makeatother
		
		}{}

\ifthenelse{\equal{\titlenum}{2}}
		{
			\makeatletter
			\renewcommand{\thechaptertitle}{\@Roman\c@chapter\chappoint}
			\renewcommand{\thechapter}{\@Roman\c@chapter.} 
			\renewcommand{\thesection}{\@arabic\c@section.}
			\renewcommand\thesubsection {\thesection\@alph\c@subsection}
			\renewcommand{\thesubsubsection}{\@roman\c@subsubsection.}
			\renewcommand{\theparagraph}{\@alph\c@paragraph)}
			\makeatother
		
		}{}

\ifthenelse{\equal{\titlenum}{3}}
{
	\makeatletter
	\renewcommand{\thechaptertitle}{\@Roman\c@chapter\chappoint}
	\renewcommand{\thechapter}{\@Roman\c@chapter.} 
	\renewcommand{\thesection}{\@arabic\c@section.}
	\renewcommand\thesubsection {\@Alph\c@subsection.}
	\renewcommand{\thesubsubsection}{\@arabic\c@subsubsection.}
	\renewcommand{\theparagraph}{\@alph\c@paragraph)}
	\makeatother

}{}




% ==============================================================
%	title styling
% ==============================================================


% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
\ifthenelse{\equal{\fancytitle}{1}}
		{
		%bericht MK Labor, titre tout en noir
			\titleformat{\chapter}% command
				[hang]% shape
				{\bf \Huge}% format
				{\prechap\thechaptertitle\sufchap}% label
				{1pt}% sep
				{}% before-code
				[]% after-code
				
			\titleformat{\section} % command
				[hang] % shape
				{\sc \bfseries \Large } % format
				{\thesection} % label
				{1cm} % sep
				{} % before-code
				[ ] % after-code
				
			\titleformat{\subsection} % command
				[hang] % shape
				{\bf \itshape \large } % format
				{\thesubsection} % label
				{0,5cm} % sep
				{} % before-code
				[ ] % after-code
				
			\titleformat{\subsubsection} % command
				[hang] % shape
				{\bfseries \slshape } % format
				{\thesubsubsection} % label
				{0,5cm} % sep
				{} % before-code
				[ ] % after-code

			\titleformat{\paragraph} % command
				[runin] % shape
				{\bf \slshape } % format
				{} % label
				{0cm} % sep
				{} % before-code
				[~:~] % after-code
				
			%\titlespacing*{command}{left}{before-sep}{after-sep}[right-sep] 
			\titlespacing*{\chapter}				{0cm}		{0cm}		{0.7cm}
			\titlespacing*{\section}				{0.5cm}	{1cm}		{0.7cm}
			\titlespacing*{\subsection}			{0.5cm}	{0.7cm}	{0.7cm}
			\titlespacing*{\subsubsection}		{0.5cm}	{0.3cm}	{0.5cm}
			\titlespacing*{\paragraph}			{0cm}	{\parskip}{3pt}%before=\parskip: longueur entre paragraph
		
		}{}
	
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
	\ifthenelse{\equal{\fancytitle}{2}}
		{
		%stage siemens
			\titleformat{\chapter}% command
				[hang]% shape
				{\bf \huge \color{MidnightBlue}}% format
				{\prechap\thechaptertitle\sufchap}% label
				{1pt}% sep
				{}% before-code
				[]% after-code
				
			\titleformat{\section} % command
				[hang] % shape
				{\sc \bfseries \Large } % format
				{\thesection} % label
				{1cm} % sep
				{} % before-code
				[ ] % after-code
				
			\titleformat{\subsection} % command
				[hang] % shape
				{\bf \itshape \large } % format
				{\thesubsection} % label
				{1cm} % sep
				{} % before-code
				[ ] % after-code
				
			\titleformat{\subsubsection} % command
				[hang] % shape
				{\bfseries \slshape } % format
				{\thesubsubsection} % label
				{0,5cm} % sep
				{} % before-code
				[ ] % after-code

			\titleformat{\paragraph} % command
				[runin] % shape
				{\bf \slshape \color{MidnightBlue}} % format
				{\theparagraph} % label
				{5pt} % sep
				{} % before-code
				[~:~] % after-code
				
			%\titlespacing*{command}{left}{before-sep}{after-sep}[right-sep] 
			\titlespacing*{\chapter}				{0cm}		{0cm}		{0.7cm}
			\titlespacing*{\section}				{0.5cm}	{1cm}		{0.7cm}
			\titlespacing*{\subsection}			{1cm}	{0.5cm}	{0.5cm}
			\titlespacing*{\subsubsection}		{2cm}	{0.5cm}	{0.5cm}
			\titlespacing*{\paragraph}			{0.7cm}	{\parskip}{3pt}%before=\parskip: longueur entre paragraph
		
		}{}
	% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
	\ifthenelse{\equal{\fancytitle}{3}}
		{	
		%bericht MK Labor, titre tout en noir + titres plus grands
			\titleformat{\chapter}% command
				[hang]% shape
				{\bf \huge}% format
				{\prechap\thechaptertitle\sufchap}% label
				{1pt}% sep
				{}% before-code
				[]% after-code
			
			\titleformat{\section} % command
				[hang] % shape
				{\sc \bfseries \Large } % format
				{\thesection} % label
				{1cm} % sep
				{} % before-code
				[ ] % after-code
			
			\titleformat{\subsection} % command
				[hang] % shape
				{\bf \itshape \large } % format
				{\thesubsection} % label
				{1cm} % sep
				{} % before-code
				[ ] % after-code
				
			\titleformat{\subsubsection} % command
				[hang] % shape
				{\large \bfseries \slshape \sc} % format
				{\thesubsubsection} % label
				{0,5cm} % sep
				{} % before-code
				[ ] % after-code

			\titleformat{\paragraph} % command
				[runin] % shape
				{\bf \slshape } % format
				{} % label
				{1pt} % sep
				{} % before-code
				[~:~] % after-code
				
			%\titlespacing*{command}{left}{before-sep}{after-sep}[right-sep] 
			\titlespacing*{\chapter}				{0cm}		{0cm}		{0.2cm}
			\titlespacing*{\section}				{0.3cm}	{1cm}		{0.7cm}
			\titlespacing*{\subsection}			{0.5cm}	{0.7cm}	{0.7cm}
			\titlespacing*{\subsubsection}		{0.5cm}	{0.3cm}	{0.5cm}
			\titlespacing*{\paragraph}			{0.7cm}	{\parskip}{3pt}%before=\parskip: longueur entre paragraph
}{}

%	==============================================================
%	page styling
%	==============================================================

\providecommand{\resetacrocounter}{} %for the acronyms to be printed the first time in each chapter
\iftoggle{newchappage}{\let\newcpage\clearpage}{\RequirePackage{placeins}\def\newcpage{\FloatBarrier}}

%attention peut causer des prob en twocolumn car les ifs ont été supprimé
\makeatletter
	%desactive mode empty page aux chapitres + newpage si besoin
	\renewcommand\chapter{\newcpage%
			\resetacrocounter
			\global\@topnum\z@%
			\@afterindentfalse%
			\secdef\@chapter\@schapter}
			
	%desactive mode plain page aux parties		
	\renewcommand\part{\clearpage%
			\null\vfil
			\secdef\@part\@spart}
			
\makeatother



\ifthenelse{\equal{\pathlogo}{no}}{%no logo avaible for page head
															\newcommand{\headlogo}{}
															}{%logo avaible for page head
															\newcommand{\headlogo}{\hfill\mbox{\includegraphics[width=0.2\textwidth]{\pathlogo}}}
															}	

									
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
\ifthenelse{\equal{\fancypage}{1}}
{
			%stylepage
		\newpagestyle{debut}{%
			\pagenumbering{Roman}
			\sethead{}{\titre}{\headlogo}
			\setfoot{}{}{}
			\headrule
			\setheadrule{0.4pt}
			}

		\newpagestyle{main}{%
			\pagenumbering{arabic}
			\sethead{\fontsize{20pt}{0pt}\selectfont \scshape \thechapter\hspace{3mm}\chaptertitle}{\titre}{\headlogo}
			\setfoot{\fancyfooter}{\centering \thepage}{}
			\headrule
			\setheadrule{0.4pt}
			}
		
}{}
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$	
\ifthenelse{\equal{\fancypage}{2}}
{
			%stylepage
		\newpagestyle{debut}{%
			\pagenumbering{Roman}
			\sethead{\name}{\titre}{\headlogo}
			\setfoot{\fancyfooter}{}{}
			\headrule
			\setheadrule{0.4pt}
			}

		\newpagestyle{main}{%
			\pagenumbering{arabic}
			\sethead{\name}{\titre}{\headlogo}
			\setfoot{\fancyfooter}{\centering \thepage}{}
			\headrule
			\setheadrule{0.4pt}
			}
		
}{}

% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

\ifthenelse{\equal{\fancypage}{3}}
{
			%stylepage
		\newpagestyle{debut}{%
			\pagenumbering{Roman}
			\sethead{\name}{\titre}{\headlogo}
			\setfoot{\fancyfooter}{\centering\Roman{page}}{}
			\headrule
			\setheadrule{0.4pt}
			}

		\newpagestyle{main}{%
			\pagenumbering{arabic}
			\sethead{\fontsize{20pt}{0pt}\selectfont \scshape \thechapter\hspace{3mm}\chaptertitle}{\titre}{\headlogo}
			\setfoot{\fancyfooter}{\centering \thepage}{}
			\headrule
			\setheadrule{0.4pt}
			}
		
}{}
% $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

\ifthenelse{\equal{\fancypage}{4}}
{
			%stylepage
		\newpagestyle{debut}{%
			\pagenumbering{Roman}
			\sethead{\name}{\titre}{\headlogo}
			\setfoot{\fancyfooter}{\centering\Roman{page}}{}
			\headrule
			\setheadrule{0.4pt}
			}

		\newpagestyle{main}{%
			\pagenumbering{arabic}
			\sethead{\name}{\titre}{\headlogo}
			\setfoot{\fancyfooter}{\centering \thepage}{}
			\headrule
			\setheadrule{0.4pt}
			}
		
}{}

%	==============================================================
%	modification table of content
%	==============================================================
\makeatletter
\newcommand{\deflen}[2]{% créer une longeur et la définir aussitot
  \expandafter\@ifdefinable\csname #1\endcsname{\prefix@deflen{#1}{#2}}%
}

\newcommand{\prefix@deflen}[2]{%
  \expandafter\newlength\csname #1\endcsname
  \expandafter\setlength\csname #1\endcsname{#2}%
}


\makeatother



%distance entre
\deflen{lenlabelsec}{2em}
\deflen{lenlabelsbsec}{2.3em}
\deflen{lenlabelsbbsec}{2.3em}
\deflen{lenlabelpara}{1.5em}

%distance à gauche du numéro
\deflen{leftspacechapter}{3em}
\deflen{leftspacesec}{\leftspacechapter +\lenlabelsec }
\deflen{leftspacesbsec}{\leftspacesec +\lenlabelsec }
\deflen{leftspacesbbsec}{\leftspacesbsec +\lenlabelsbsec }
\deflen{leftspacepara}{\leftspacesbbsec +\lenlabelsbbsec }





\RequirePackage{titletoc}
\titlecontents{chapter} %hsectioni
			[\leftspacechapter] %hlefti % ie, 1.5em (chapter) + 2.3em
			{}%habove-codei
			{\contentslabel{\lenlabelsec}}%hnumbered-entry-formati
			{\hspace*{-\lenlabelsec}}%hnumberless-entry-formati
			{\titlerule*[1pc]{.}\contentspage}%hfiller-page-formati
			[]%hbelow-codei

\titlecontents{section} %hsectioni
			[\leftspacesec ]
			{}%habove-codei
			{\contentslabel{\lenlabelsec}}%hnumbered-entry-formati
			{\hspace*{-\lenlabelsec}}%hnumberless-entry-formati
			{\titlerule*[1pc]{.}\contentspage}%hfiller-page-formati
			[]%hbelow-codei


\titlecontents{subsection} %hsectioni
			[\leftspacesbsec]
			{}%habove-codei
			{\contentslabel{\lenlabelsbsec}}%hnumbered-entry-formati
			{\hspace*{-\lenlabelsbsec}}%hnumberless-entry-formati
			{\titlerule*[1pc]{.}\contentspage}%hfiller-page-formati
			[]%hbelow-codei

\titlecontents{subsubsection} %hsectioni
			[\leftspacesbbsec]
			{}%habove-codei
			{\contentslabel{\lenlabelsbbsec}}%hnumbered-entry-formati
			{\hspace*{-\lenlabelsbbsec}}%hnumberless-entry-formati
			{\titlerule*[1pc]{.}\contentspage}%hfiller-page-formati
			[]%hbelow-codei

\titlecontents{paragraph} %hsectioni
			[\leftspacepara]
			{}%habove-codei
			{\contentslabel{\lenlabelpara}}%hnumbered-entry-formati
			{\hspace*{-\lenlabelpara}}%hnumberless-entry-formati
			{\titlerule*[1pc]{.}\contentspage}%hfiller-page-formati
			[]%hbelow-codei